---
title: ğŸš€SvelteåŸç†å’Œè¿›é˜¶çœ‹è¿™ç¯‡å°±å¤Ÿäº†ğŸš€
isTimeLine: true
date: 2023-05-23
categories:
  - å‰ç«¯
tags:
  - JavaScript
  - Svelte
---
ä½œä¸ºåèµ·ä¹‹ç§€ï¼Œ`Svelte`åˆ°åº•æ˜¯æ€ä¹ˆä¿˜è·å¤§æ‰¹å¼€å‘è€…çš„å‘¢ï¼Ÿæˆ‘ä»¬å…ˆä»å®ƒçš„ç‰¹æ€§å¼€å§‹è¯´èµ·ã€‚

## Svelteç‰¹æ€§

*   ğŸš€ç®€æ´çš„è¯­æ³•
*   âœˆæ— `è™šæ‹ŸDOM`
*   ğŸš—æ­£åœ¨çš„å“åº”å¼

### ğŸš€ç®€æ´çš„è¯­æ³•

å®˜ç½‘ç»™å‡ºäº†ä¸€ä¸ªä¸‰å¤§æ¡†æ¶çš„åŒæ ·åŠŸèƒ½çš„ä¾‹å­ä½œæ¯”è¾ƒ

#### Reactå†™æ³•

```js
import React, { useState } from 'react';

export default () => {
  const [a, setA] = useState(1);
  const [b, setB] = useState(2);

  function handleChangeA(event) {
    setA(+event.target.value);
  }

  function handleChangeB(event) {
    setB(+event.target.value);
  }

  return (
    <div>
      <input type="number" value={a} onChange={handleChangeA}/>
      <input type="number" value={b} onChange={handleChangeB}/>

      <p>{a} + {b} = {a + b}</p>
    </div>
  );
};
```

#### Vueå†™æ³•

```html
<template>
  <div>
    <input type="number" v-model.number="a">
    <input type="number" v-model.number="b">

    <p>{{a}} + {{b}} = {{a + b}}</p>
  </div>
</template>

<script>
  export default {
    data: function() {
      return {
        a: 1,
        b: 2
      };
    }
  };
</script>
```

#### Svelteå†™æ³•

```html
<script>
    let a = 1;
    let b = 2;
</script>

<input type="number" bind:value={a}>
<input type="number" bind:value={b}>

<p>{a} + {b} = {a + b}</p>
```

ç»“æœä¸€ç›®äº†ç„¶äº†ã€‚

`Svelte`è®¤ä¸ºï¼Œä½ å†™çš„ä»£ç è¶Šå¤šï¼Œé€ æˆæ›´å¤šçš„`bug`çš„æ¦‚ç‡è¶Šå¤§ã€‚

### âœˆæ— è™šæ‹ŸDOM

`Svelte`æ”¾å¼ƒäº†æµè¡Œçš„`è™šæ‹ŸDOM`æ–¹æ¡ˆï¼Œè™½ç„¶`è™šæ‹ŸDOM`è¶³å¤Ÿçš„å¿«ï¼Œä½†æ˜¯`è™šæ‹ŸDOM`æœ€è‡´å‘½çš„é—®é¢˜æ˜¯ä¸ç®¡çŠ¶æ€æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œéƒ½ä¼šè¢«é‡æ–°è®¡ç®—å¹¶ä¸”æ›´æ–°ã€‚

`React`ä¼šä»åº”ç”¨æ ¹èŠ‚ç‚¹å¼€å§‹é‡æ–°åŠ è½½ï¼Œ`Vue`ä¼šä»æ‰€åœ¨ç»„ä»¶å¼€å§‹é‡æ–°åŠ è½½ã€‚

`Svelte`å›å½’åˆ°äº†åŸç”Ÿ`JavaScript`ï¼Œåœ¨`Svelte`ä¸­ï¼Œæ¯ä¸ªç»„ä»¶éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„`JavaScript`ç±»ï¼Œç§°ä¸ºâ€œç»„ä»¶å®ä¾‹â€ã€‚å½“ç»„ä»¶çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œ`Svelte`ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ç»„ä»¶å®ä¾‹ï¼Œå¹¶ä½¿ç”¨å·®å¼‚ç®—æ³•æ¯”è¾ƒæ–°æ—§ç»„ä»¶å®ä¾‹çš„`DOM`ç»“æ„ï¼Œç„¶åæ›´æ–°éœ€è¦æ›´æ”¹çš„éƒ¨åˆ†ã€‚

`Svelte`ä½¿ç”¨çš„å·®å¼‚ç®—æ³•ä¸ä¼ ç»Ÿçš„`è™šæ‹ŸDOM`å®ç°ç±»ä¼¼ï¼Œéƒ½æ˜¯å°†æ–°æ—§`DOMæ ‘`è¿›è¡Œæ¯”è¾ƒï¼Œæ‰¾å‡ºéœ€è¦æ›´æ–°çš„éƒ¨åˆ†ã€‚ä½†æ˜¯ï¼Œ`Svelte`ä½¿ç”¨äº†ä¸€äº›ä¼˜åŒ–æŠ€å·§æ¥å‡å°‘æ¯”è¾ƒçš„å¤æ‚æ€§å’Œ`DOM`æ“ä½œçš„æ•°é‡ã€‚

*   ğŸ’ä½¿ç”¨keyæ ‡è®°DOM
*   ğŸ’åˆå¹¶DOMï¼ˆç§»ä½ç®—æ³•ï¼‰ã€å‡å°‘DOM
*   ğŸ’ç¼“å­˜DPOMï¼ˆå¯å˜é•¿ç¼“å­˜ï¼‰

##### ğŸ’ä½¿ç”¨keyæ ‡è®°DOM

ä½¿ç”¨`â€œkeyâ€`å±æ€§æ¥å¸®åŠ©`Svelte`è¯†åˆ«ç›¸åŒç±»å‹çš„å…ƒç´ ã€‚å½“`Svelte`åœ¨æ¯”è¾ƒæ–°æ—§`DOM`æ ‘æ—¶é‡åˆ°ç›¸åŒç±»å‹çš„å…ƒç´ æ—¶ï¼Œå®ƒä¼šä½¿ç”¨`â€œkeyâ€`å±æ€§æ¥åˆ¤æ–­è¿™äº›å…ƒç´ æ˜¯å¦ç›¸åŒï¼Œå¹¶é¿å…è¿›è¡Œä¸å¿…è¦çš„æ›´æ–°ã€‚è¿™å¯ä»¥å‡å°‘æ¯”è¾ƒçš„å¤æ‚æ€§å’Œ`DOM`æ“ä½œçš„æ•°é‡ï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚

##### ğŸ’åˆå¹¶DOMï¼ˆç§»ä½ç®—æ³•ï¼‰

Svelteè¿˜ä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºâ€œç§»ä½â€ç®—æ³•çš„æŠ€å·§æ¥è¿›ä¸€æ­¥ä¼˜åŒ–å·®å¼‚ç®—æ³•ã€‚ç§»ä½ç®—æ³•æ˜¯ä¸€ç§å°†å¤šä¸ªè¿ç»­çš„DOMæ“ä½œåˆå¹¶ä¸ºå•ä¸ªæ“ä½œçš„æŠ€æœ¯ï¼Œä»è€Œå‡å°‘DOMæ“ä½œçš„æ•°é‡å’Œå¤æ‚æ€§ã€‚

å¦å¤–ï¼Œè¿˜é’ˆå¯¹{{#if}}æŒ‡ä»¤åšäº†ä¼˜åŒ–ï¼Œ`Svelte`ä¼šä½¿ç”¨`DOM`å…ƒç´ çš„æ’å…¥å’Œç§»é™¤æ¥éšè—æˆ–æ˜¾ç¤ºå…ƒç´ ï¼Œè€Œä¸æ˜¯ä½¿ç”¨`CSS`çš„`display:none`ç­‰æ–¹å¼ã€‚è¿™ç§æ–¹æ³•ä¹Ÿå¯ä»¥å‡å°‘DOMæ“ä½œçš„æ•°é‡å’Œå¤æ‚æ€§ã€‚

##### ğŸ’ç¼“å­˜DOMï¼ˆå¯å˜é•¿ç¼“å­˜ï¼‰

`Svelte`è¿˜ä½¿ç”¨äº†ä¸€ç§ç§°ä¸ºâ€œå¯å˜é•¿åº¦ç¼“å­˜â€ï¼ˆ`VLC`ï¼‰çš„æŠ€æœ¯æ¥è¿›ä¸€æ­¥ä¼˜åŒ–å·®å¼‚ç®—æ³•ã€‚å¯å˜é•¿åº¦ç¼“å­˜æ˜¯ä¸€ç§å°†æœ€è¿‘ä½¿ç”¨çš„å…ƒç´ ç¼“å­˜èµ·æ¥ï¼Œä»¥ä¾¿å®ƒä»¬å¯ä»¥æ›´å¿«åœ°è¢«è®¿é—®å’Œä½¿ç”¨çš„æŠ€æœ¯ã€‚å½“`Svelte`æ¯”è¾ƒæ–°æ—§`DOMæ ‘`æ—¶ï¼Œå®ƒå¯ä»¥ä½¿ç”¨`VLC`ç¼“å­˜æ¥å¿«é€ŸæŸ¥æ‰¾å’Œè®¿é—®æœ€è¿‘ä½¿ç”¨çš„å…ƒç´ ï¼Œä»è€Œå‡å°‘æ¯”è¾ƒçš„å¤æ‚æ€§å’Œæ—¶é—´å¤æ‚åº¦ã€‚

æ‰€ä»¥ï¼ŒSvelteè™½ç„¶æ²¡æœ‰è™šæ‹ŸDOMï¼Œä½†æ˜¯å®ƒçš„æ€§èƒ½åè€Œæ›´å¥½ã€‚

### ğŸš—çœŸæ­£çš„å“åº”å¼

ä»€ä¹ˆæ˜¯å“åº”å¼ï¼Ÿå°±æ˜¯å½“ä¸€ä¸ªå€¼å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªå€¼çš„åœ°æ–¹åšå‡ºç›¸åº”çš„æ”¹å˜ã€‚

å¦‚æœä¸åŒçš„äººè®¾è®¡å“åº”å¼çš„åŠŸèƒ½ï¼Œå®ƒçš„ä½¿ç”¨æ–¹æ¡ˆä¹Ÿä¼šä¸å°½ç›¸åŒã€‚

ä¾‹å¦‚ï¼Œæ—©æœŸçš„`Svelte`å†™æ³•å¦‚ä¸‹ï¼š

```js
const { count } = this.get();
this.set({
  count: count + 1
});
```

`React`çš„å†™æ³•

```js
const { count } = this.state;
this.setState({
  count: count + 1
});
```

`hook`

```js
const [count, setCount] = useState(props.count)
setCount(count + 1)
```

`Vue3`å†™æ³•

```js
const { count } = defineProps(props)
count ++
```

è¿™äº›æ–¹æ¡ˆéƒ½æ˜¯åŸºäºä¸€äº›å“åº”å¼çš„Apiå®ç°çš„å“åº”å¼åŠŸèƒ½ã€‚

`Svelte`æ„è¯†åˆ°æœ€å¥½çš„`API`å°±æ˜¯æ ¹æœ¬æ²¡æœ‰ `API`ã€‚æˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

```js
let count = 0
count +=1
```

ä»¥ä¸Šå°±æ˜¯`Svelte`çš„ä¸»è¦ç‰¹æ€§ã€‚æ€»ç»“ä¸‹ï¼š

*   `Svelte`æ‹¥æœ‰æ¥è¿‘åŸç”Ÿ`JavaScript`çš„å†™æ³•
*   `Svelte`æ²¡æœ‰è™šæ‹Ÿ`DOM`ï¼Œä½¿ç”¨åŸç”Ÿ`DOM`æè¿°ç»„ä»¶
*   `Svelte`æ²¡æœ‰`Api`

## Svelteç¼–è¯‘åŸç†

æ—¢ç„¶`Svelte`æ²¡æœ‰`Api`ï¼Œé‚£åˆ°åº•æ˜¯æ€ä¹ˆè¿½è¸ªå˜é‡å˜åŒ–çš„å‘¢ï¼Ÿ

æ¥ä¸‹æ¥æˆ‘ä»¬ç”±ç®€å•åˆ°å¤æ‚ï¼Œæ¥çœ‹çœ‹`Svelte`çš„ç¼–è¯‘ç»“æœã€‚

é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹ï¼Œä¸‹é¢çš„ä»£ç ä¼šè¢«ç¼–è¯‘æˆå•¥æ ·çš„ï¼š

```html
<h1>Hello world!</h1>
```

```js
/* App.svelte generated by Svelte v3.59.1 */
import {
  SvelteComponent,
  detach,
  element,
  init,
  insert,
  noop,
  safe_not_equal
} from "svelte/internal";

function create_fragment(ctx) {
  let h1;

  return {
    c() {
      h1 = element("h1");
      h1.textContent = "Hello world!";
    },
    m(target, anchor) {
      insert(target, h1, anchor);
    },
    p: noop,
    i: noop,
    o: noop,
    d(detaching) {
      if (detaching) detach(h1);
    }
  };
}

class App extends SvelteComponent {
  constructor(options) {
    super();  
    init(this, options, null, create_fragment, safe_not_equal, {});
  }
}

export default App;
```

å¾ˆæ˜æ˜¾ï¼Œç»„ä»¶ç¼–è¯‘ä¹‹åï¼Œä¼šè¿”å›ä¸€ä¸ªç»§æ‰¿äº†`SvelteComponent`çš„ç±»ï¼Œå¹¶ä¸”åœ¨æ„é€ å‡½æ•°ä¸­æ‰§è¡Œäº†`init`æ–¹æ³•ï¼Œå®ƒçš„å…¶ä¸­ä¸€ä¸ªå‚æ•°ä¸ºåœ¨ç»„ä»¶ä¸­å®šä¹‰çš„`create_fragment`å‡½æ•°ã€‚

è¿™ä¸ªå‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ç»„ä»¶å¯¹åº”çš„çš„`create``mount``update``delete`æ“ä½œã€‚ç”±äºä¸Šé¢çš„ä»£ç ä¸­æ˜¯ä¸ªé™æ€çš„å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥`p`å¯¹åº”çš„å€¼ä¸º`noop`å³`no operate`æ²¡æœ‰æ“ä½œã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç å¦‚ä¸‹ï¼š

```js
<script>
  let count = 0
</script>
<h1>Hello world!</h1>
```

æ­¤æ—¶ç»„ä»¶ç¼–è¯‘ä¹‹åï¼Œä»…ä»…å‡ºç°äº†

    let count = 0

å…¶ä½™æ²¡æœ‰å˜åŒ–ï¼Œï¼ˆæ‰€ä»¥ä»£ç é‡Œæ²¡æœ‰ç”¨åˆ°çš„å˜é‡ï¼Œæˆ‘ä»¬åº”è¯¥å³æ—¶åˆ é™¤ï¼‰

æ¥ç€ï¼Œæˆ‘ä»¬æ–°å¢ä»£ç å¦‚ä¸‹ï¼š

```js
<script>
let count = 0
</script>
<h1 on:click={() => count++}>Hello world!</h1>
```

```js
function create_fragment(ctx) {
  let h1;
  let mounted;
  let dispose;
  
  return {
    c() {
      h1 = element("h1");
      h1.textContent = "Hello world!";
    },
    m(target, anchor) {
      insert(target, h1, anchor);
      if (!mounted) {
        dispose = listen(h1, "click", /*click_handler*/ ctx[1]);
        mounted = true;
      }
    },
    // ...
    d(detaching) {
      if (detaching) detach(h1);
      mounted = false;
      dispose();
    }
  };
}

function instance($$self, $$props, $$invalidate) {
  let count = 0;
  const click_handler = () => $$invalidate(0, count++, count);
  return [count, click_handler];
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨`mounted`ä¹‹åä½¿ç”¨`listen`æ–¹æ³•æ–°å¢äº†ä¸€ä¸ªé’ˆå¯¹`h1`çš„`click`æ–¹æ³•çš„ç›‘å¬äº‹ä»¶ï¼Œå¹¶ä¸”åœ¨`delete`é˜¶æ®µç§»é™¤ç›‘å¬äº‹ä»¶ã€‚

åŒæ—¶å¤šäº†ä¸ªå®ä¾‹æ–¹æ³•`instance`ï¼Œå®ƒçš„è¿”å›å€¼æ˜¯`count`çš„å®é™…å€¼ï¼Œä»¥åŠä¿®æ”¹`count`çš„å¤„ç†å‡½æ•°ã€‚**è¯·è®°ä½è¿™é‡Œï¼Œåé¢è¿˜ä¼šæåˆ°ã€‚**

å€¼å¾—æ³¨æ„çš„æ˜¯`h1`çš„`click`äº‹ä»¶çš„å‚æ•°æ˜¯`/*click_handler*/ ctx[1])`

```js
function instance($$self, $$props, $$invalidate) {
  let count = 0;
  const click_handler = () => $$invalidate(0, count++, count);
  return [count, click_handler];
}
```

æ­¤æ—¶ï¼Œinitæ–¹æ³•ä¹Ÿå‘ç”Ÿäº†æ”¹å˜

```js
// ä¹‹å‰
init(this, options, null, create_fragment, safe_not_equal, {});
// ä¹‹å
init(this, options, instance, create_fragment, safe_not_equal, {});
```

æœ€å…³é”®çš„æ¥äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬ç»§ç»­ä¿®æ”¹ä»£ç å¦‚ä¸‹

```js
<script>
let count = 0
</script>
<h1 on:click={() => count++}>Hello world!{count}</h1>
```

å†å»æŸ¥çœ‹ç¼–è¯‘ç»“æœï¼Œ`create_fragment`å‘ç”Ÿäº†é‡å¤§å˜åŒ–

```js
function create_fragment(ctx) {
  let h1;
  let t0;
  let t1;
  let mounted;
  let dispose;
  
  return {
    c() {
      h1 = element("h1");
      h1.textContent = "Hello world!";
      t0 = text("Hello world!");
      t1 = text(/*count*/ ctx[0]);
    },
    m(target, anchor) {
      insert(target, h1, anchor);
      append(h1, t0);
      append(h1, t1);
      if (!mounted) {
        dispose = listen(h1, "click", /*click_handler*/ ctx[1]);
        mounted = true;
      }
    },
    // ...
    p(ctx, [dirty]) {
      if (dirty & /*count*/ 1) set_data(t1, /*count*/ ctx[0]);
    },
    d(detaching) {
      if (detaching) detach(h1);
      mounted = false;
      dispose();
    }
  };
}
```

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œ`t1`çš„å€¼ä¸º`/* count */ ctx[0]`

`instance`çš„è¿”å›å€¼ä¸º`[count, click_handler]`ï¼Œ

ç»“åˆå‰é¢çš„å†…å®¹ï¼Œå¾—å‡ºä¸€ä¸ªæ˜æ˜¾çš„ç»“è®ºï¼š`instance`çš„è¿”å›å€¼å°±æ˜¯`create_fragment`çš„å‚æ•°ï¼

å¥½äº†ï¼Œå•°é‡Œå§å—¦è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬ç»ˆäºå¯ä»¥è®¨è®ºå¼€å¤´çš„é—®é¢˜äº†

> æ—¢ç„¶Svelteæ²¡æœ‰Apiï¼Œé‚£åˆ°åº•æ˜¯æ€ä¹ˆè¿½è¸ªå˜é‡å˜åŒ–çš„å‘¢ï¼Ÿ

`svelte`åœ¨ç¼–è¯‘æ—¶ï¼Œä¼šæ£€æµ‹æ‰€æœ‰å˜é‡çš„èµ‹å€¼è¡Œä¸ºï¼Œå¹¶å°†å˜åŒ–åçš„å€¼å’Œèµ‹å€¼çš„è¡Œä¸ºï¼Œä½œä¸ºåˆ›å»ºç‰‡æ®µçš„å‚æ•°ã€‚

è¿™å°±æ˜¯`svelte`æœ´ç´ çš„ç¼–è¯‘åŸç†ã€‚

## Svelteè¿è¡Œæ—¶åŸç†

ç°åœ¨æˆ‘ä»¬åˆæœ‰äº†ä¸€ä¸ªæ–°çš„é—®é¢˜ã€‚æˆ‘ä»¬å·²ç»å¯ä»¥æ„ŸçŸ¥åˆ°å€¼çš„å˜åŒ–ï¼Œé‚£æ˜¯æ€ä¹ˆå°†å€¼å¾—å˜åŒ–æ›´æ–°åˆ°é¡µé¢ä¸­çš„äº†ã€‚

ä½ å¯èƒ½é©¬ä¸Šæƒ³åˆ°çš„æ˜¯`create_fragment`è¿”å›çš„`updata`æ–¹æ³•å•Šã€‚è¿™é‡Œä»…ä»…æ˜¯æä¾›äº†æ›´æ–°é¡µé¢DOMçš„æ–¹æ³•ï¼Œé‚£æ˜¯ä»€ä¹ˆæ ·çš„æ—¶æœºè°ƒç”¨è¿™ä¸ªæ›´æ–°æ–¹æ³•çš„å‘¢ï¼Ÿ

### âœˆ`init`æ–¹æ³•

å…¶å®ï¼Œsvelteçš„ç¼–è¯‘ç»“æœæ˜¯è¿è¡Œæ—¶è¿è¡Œçš„ä»£ç ã€‚åœ¨è¿›å…¥è¿è¡Œæ—¶ï¼Œé¦–å…ˆæ‰§è¡Œ`init`æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š

*   ğŸ’åˆå§‹åŒ–çŠ¶æ€
*   ğŸ’åˆå§‹åŒ–å‘¨æœŸå‡½æ•°
*   ğŸ’æ‰§è¡Œ`instance`æ–¹æ³•ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­æ ‡è®°`è„ç»„ä»¶`
*   ğŸ’æ‰§è¡Œæ‰€æœ‰`beforeUpdate`ç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°
*   ğŸ’æ‰§è¡Œåˆ›å»ºç‰‡æ®µ`create_fragment`å‡½æ•°
*   ğŸ’æŒ‚è½½å½“å‰ç»„ä»¶å¹¶æ‰§è¡Œ`create_fragement`è¿”å›çš„`mï¼ˆmountedï¼‰`æ–¹æ³•
*   ğŸ’æ‰§è¡Œ`flush`æ–¹æ³•

ä½ å¯ä»¥è·³è¿‡è¿™æ®µä»£ç ï¼Œä¸å½±å“é˜…è¯»

```js
export function init(
  component,
  options,
  instance,
  create_fragment,
  not_equal,
  props,
  append_styles,
  dirty = [-1]
) {
  const parent_component = current_component;
  set_current_component(component);

  const $$: T$$ = component.$$ = {
    fragment: null,
    ctx: [],

    // state
    props,
    update: noop,
    not_equal,
    bound: blank_object(),

    // lifecycle
    on_mount: [],
    on_destroy: [],
    on_disconnect: [],
    before_update: [],
    after_update: [],
    context: new Map(options.context || (parent_component ? parent_component.$$.context : [])),

    // everything else
    callbacks: blank_object(),
    dirty,
    skip_bound: false,
    root: options.target || parent_component.$$.root
  };

  append_styles && append_styles($$.root);

  let ready = false;

  $$.ctx = instance
    ? instance(component, options.props || {}, (i, ret, ...rest) => {
        const value = rest.length ? rest[0] : ret;
        if ($$.ctx && not_equal($$.ctx[i], $$.ctx[i] = value)) {
            if (!$$.skip_bound && $$.bound[i]) $$.bound[i](value);
            if (ready) make_dirty(component, i);
        }
        return ret;
    })
    : [];

  $$.update();
  ready = true;
  run_all($$.before_update);

  // `false` as a special case of no DOM component
  $$.fragment = create_fragment ? create_fragment($$.ctx) : false;

  if (options.target) {
    if (options.hydrate) {
        start_hydrating();
        const nodes = children(options.target);
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        $$.fragment && $$.fragment!.l(nodes);
        nodes.forEach(detach);
    } else {
        // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
        $$.fragment && $$.fragment!.c();
    }

    if (options.intro) transition_in(component.$$.fragment);
    mount_component(component, options.target, options.anchor, options.customElement);
    end_hydrating();
    flush();
  }

  set_current_component(parent_component);
}
```

çœ‹èµ·æ¥ï¼Œ`flush`æ–¹æ³•å¾ˆå¯èƒ½æ‰æ˜¯æˆ‘ä»¬éœ€è¦çš„ç­”æ¡ˆã€‚

### âœˆ`flush`æ–¹æ³•

`flush`çš„æ–¹æ³•ä¸»è¦åšäº†ä¸€ä»¶äº‹ï¼š

éå†éœ€è¦æ›´æ–°çš„ç»„ä»¶ï¼ˆ`dirty_components`ï¼‰ï¼Œç„¶åæ›´æ–°å®ƒï¼Œå¹¶ä¸”è°ƒç”¨`afterUpdate`æ–¹æ³•ã€‚

```js
export function flush() {
  // Do not reenter flush while dirty components are updated, as this can
  // result in an infinite loop. Instead, let the inner flush handle it.
  // Reentrancy is ok afterwards for bindings etc.
  if (flushidx !== 0) {
    return;
  }

  const saved_component = current_component;

  do {
    // first, call beforeUpdate functions
    // and update components
    try {
        while (flushidx < dirty_components.length) {
            const component = dirty_components[flushidx];
            flushidx++;
            set_current_component(component);
            update(component.$$);
        }
    } catch (e) {
        // reset dirty state to not end up in a deadlocked state and then rethrow
        dirty_components.length = 0;
        flushidx = 0;
        throw e;
    }

    set_current_component(null);

    dirty_components.length = 0;
    flushidx = 0;

    // then, once components are updated, call
    // afterUpdate functions. This may cause
    // subsequent updates...
    for (let i = 0; i < render_callbacks.length; i += 1) {
        const callback = render_callbacks[i];

        if (!seen_callbacks.has(callback)) {
            // ...so guard against infinite loops
            seen_callbacks.add(callback);

            callback();
        }
    }

    render_callbacks.length = 0;
  } while (dirty_components.length);

  while (flush_callbacks.length) {
    flush_callbacks.pop()();
  }

  update_scheduled = false;
  seen_callbacks.clear();
  set_current_component(saved_component);
}
```

æˆ‘ä»¬å†æ¥çœ‹çœ‹å…·ä½“çš„æ›´æ–°æ“ä½œ`update`å‡½æ•°åšäº†å•¥

*   é¦–å…ˆæ‰§è¡Œæ‰€æœ‰çš„`before_update`æ–¹æ³•
*   ç„¶åæ‰§è¡Œ`create_fragment`è¿”å›çš„`pï¼ˆupdateï¼‰`æ–¹æ³•

```js
function update($$) {
    if ($$.fragment !== null) {
        $$.update();
        run_all($$.before_update);
        const dirty = $$.dirty;
        $$.dirty = [-1];
        $$.fragment && $$.fragment.p($$.ctx, dirty);

        $$.after_update.forEach(add_render_callback);
    }
}
```

å¥½äº†ï¼Œæˆ‘ä»¬æ€»ç»“ä¸‹ï¼šåœ¨è¿è¡Œæ—¶

*   ğŸ’é¦–å…ˆï¼Œåˆå§‹åŒ–çŠ¶æ€ã€åˆå§‹åŒ–å‘¨æœŸå‡½æ•°
*   ğŸ’æ¥ç€ï¼Œæ‰§è¡Œ`instance`æ–¹æ³•ï¼Œåœ¨å›è°ƒå‡½æ•°ä¸­æ ‡è®°`è„ç»„ä»¶`
*   ğŸ’æ¥ç€ï¼Œæ‰§è¡Œæ‰€æœ‰`beforeUpdate`ç”Ÿå‘½å‘¨æœŸçš„å‡½æ•°
*   ğŸ’ç„¶åï¼Œæ‰§è¡Œåˆ›å»ºç‰‡æ®µ`create_fragment`å‡½æ•°
*   ğŸ’æ¥ç€ï¼ŒæŒ‚è½½å½“å‰ç»„ä»¶å¹¶æ‰§è¡Œ`create_fragement`è¿”å›çš„`mï¼ˆmountedï¼‰`æ–¹æ³•
*   ğŸ’ç„¶åï¼Œæ‰§è¡Œ`flush`æ–¹æ³•
*   ğŸ’é¦–å…ˆï¼Œæ‰§è¡Œæ‰€æœ‰çš„`before_update`æ–¹æ³•
*   ğŸ’ç„¶åï¼Œæ‰§è¡Œ`create_fragment`è¿”å›çš„`pï¼ˆupdateï¼‰`æ–¹æ³•
*   ğŸ’æœ€åï¼Œæ‰§è¡Œ`afterUpdate`æ–¹æ³•

## æ€»ç»“

å¥½äº†ï¼Œä»Šå¤©çš„åˆ†äº«å°±è¿™äº›äº†ï¼Œæ€»çš„æ¥è¯´ï¼Œ`Svelte`çš„å“åº”å¼åŸç†è™½ç„¶å¾ˆæœ´ç´ ï¼Œä½†æ˜¯å´æ‹¥æœ‰äº†æ›´å¥½çš„æ€§èƒ½ï¼ŒåŒæ—¶ä¹Ÿé™ä½äº†å¼€å‘è€…çš„è®°å¿†è´Ÿæ‹…ã€‚æˆ‘è§‰å¾—è¿™æ˜¯`svelte`æœ€æˆåŠŸçš„åœ°æ–¹ã€‚

å¦‚æœä½ å‘ç°æ–‡ç« æœ‰é”™è¯¯çš„åœ°æ–¹ï¼Œè¯·åŠæ—¶å‘Šè¯‰æˆ‘ï¼Œååˆ†æ„Ÿè°¢ã€‚
